---

services:
  server:
    image: ghcr.io/prmiguel/mitm-proxy-server:main
    build: ./server
    container_name: proxyserver
    entrypoint: "mitmweb --web-host 0.0.0.0 -s /addons/modify_response.py"
    networks:
      app-network:
        ipv4_address: 172.28.5.1
    ports:
      - '6080:8080'
      - '6081:8081'
    volumes:
      - dotmitmproxy:/home/mitmproxy/.mitmproxy:rw
      - addonsmitmproxy:/addons:ro
  client:
    image: ghcr.io/prmiguel/mitm-proxy-client:main
    container_name: proxyclient
    build: ./client
    ports:
        - '6901:6901'
    depends_on:
      - server
    environment:
        - PROXY_SERVER=172.28.5.1:8080
        - HTTP_PROXY=http://172.28.5.1:8080
        - HTTPS_PROXY=http://172.28.5.1:8080
        - http_proxy=http://172.28.5.1:8080
        - https_proxy=http://172.28.5.1:8080
        # - CA_CERT=$CA_CERT
    shm_size: '1gb'
    networks:
      app-network:
        ipv4_address: 172.28.5.2
    volumes:
      - dotmitmproxy:/dotmitmproxy:ro
      - addonsmitmproxy:/addons:rw
  ide:
    image: ghcr.io/prmiguel/mitm-proxy-ide:main
    container_name: proxyide
    environment:
      - DEFAULT_WORKSPACE=/addons
    volumes:
      - addonsmitmproxy:/addons:rw
    ports:
      - 8443:8443
    restart: unless-stopped
    networks:
      app-network:
        ipv4_address: 172.28.5.3

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          ip_range: 172.28.5.0/24
          gateway: 172.28.5.254
      options:
        level: "0"

volumes:
  dotmitmproxy:
  addonsmitmproxy:
